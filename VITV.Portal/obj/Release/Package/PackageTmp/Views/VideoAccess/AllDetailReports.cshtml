@model VideoCategory
@{
    ViewBag.Title = Model.Name;
    List<VITV.Portal.ViewModel.AgeReport> ages = ViewBag.Ages;
    List<VITV.Portal.ViewModel.GenderReport> genders = ViewBag.Genders;
    List<VITV.Portal.ViewModel.SocialNetworkReport> socialNetworks = ViewBag.SocialNetworks;
    List<VITV.Portal.ViewModel.CityReport> cities = ViewBag.Cities;
}

<div class="row">
    <div class="col-lg-12">
        <div class="main-box clearfix">

            <header class="main-box-header">
                <div class="row">
                    <div class="col-lg-4">
                        <a href="@Url.Action("allreports", "videoaccess")" class="btn btn-primary pull-left">
                            <i class="fa fa-arrow-left"></i> Quay về trang tổng quát
                        </a>
                    </div>
                    <div class="col-lg-4">
                        <h1><b>@Model.Name trong năm <span id="selected-year">@DateTime.Now.Year</span></b></h1>
                    </div>
                    <div class="col-lg-4">
                        <div class="col-lg-4">

                        </div>
                        <div class="col-lg-4 pull-right">
                            <select id="yearSelect" class="form-control">
                                @for (int y = 2015; y <= DateTime.Now.Year; y++)
                                {
                                    <option value="@y" @(y == DateTime.Now.Year ? "selected" : "")>@y</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </header>

            <div class="main-box-body clearfix">
                
                <div class="row">

                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#tab-1" data-toggle="tab">Thông tin cơ bản</a></li>
                        <li><a href="#tab-2" data-toggle="tab">Thông tin theo tuần</a></li>

                        <li><a href="#tab-3" data-toggle="tab">So sánh các tuần(Tuần đầu, coi lại)</a></li>
                        <li><a href="#tab-4" data-toggle="tab">So sánh các tuần (Không trùng, trùng)</a></li>
                        <li><a href="#tab-5" data-toggle="tab">So sánh các tuần (Video mới, video khác)</a></li>

                        @if (!User.IsInRole("kinhdoanh"))
                        {
                        <li><a href="#tab-6" data-toggle="tab">Google Analytics</a></li>
                        }
                    </ul>
                    <div class="tab-content tab-content-body clearfix">
                        <div class="tab-pane fade in active" id="tab-1">
                            <div class="row" style="margin-top:10px">
                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">

                                        <span class="headlineview">Chuyên mục</span>
                                        <span class="valueview" id="category"></span>

                                        <span class="headlineview">Chuyên đề</span>
                                        <span class="valueview" id="type"></span>

                                        <span class="headlineview">Số lượng video</span>
                                        <span class="valueview" id="videocount"></span>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">
                                        <span class="headlineview">Tổng cộng tất cả</span>
                                        <span class="valueview" id="sumview"></span>


                                        <span class="headlineview">Tổng cộng trong tuần đầu tiên</span>
                                        <span class="valueview" id="sum7dayview"></span>

                                        <span class="headlineview">Số lượt xem lại</span>
                                        <span class="valueview" id="sumreview"></span>

                                    </div>
                                </div>

                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">
                                        <span class="headlineview">Trung bình trong tuần đầu tiên</span>
                                        <span class="valueview" id="avg7dayview"></span>

                                        <span class="headlineview">Trung bình cao nhất tuần đầu</span>
                                        <span class="valueview" id="firstweekaveragehighest"></span>

                                        <span class="headlineview">Trung bình tất cả</span>
                                        <span class="valueview" id="avgview"></span>

                                        <span class="headlineview">Trung bình cao nhất tất cả</span>
                                        <span class="valueview" id="alltimeaveragehighest"></span>

                                        <span class="headlineview">Trung vị trong tuần đầu tiên</span>
                                        <span class="valueview" id="median7dayview"></span>

                                        <span class="headlineview">Trung vị tất cả</span>
                                        <span class="valueview" id="medianview"></span>
                                    </div>
                                </div>

                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">
                                        <span class="headlineview">Cao nhất tuần đầu</span>
                                        <span class="valueview" id="max7dayview"></span>

                                        <span class="headlineview">Thấp nhất tuần đầu</span>
                                        <span class="valueview" id="min7dayview"></span>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">

                                        <span class="headlineview" id="maxheadview">Cao nhất tất cả</span>
                                        <span class="valueview" id="maxview"></span>

                                        <span class="headlineview" id="minheadview">Thấp nhất tất cả</span>
                                        <span class="valueview" id="minview"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tab-2">
                            <div class="row">
                                <div class="col-md-10">
                                    <div id="main-chart" style="height: 600px; min-width: 310px;" class="chart"></div>
                                </div>
                                <div class="col-md-2">
                                    @*<div class="col-md-12 checkbox-nice">
                                        <input type="checkbox" id="cbToggleMarker" checked />
                                        <label for="cbToggleMarker">Hiển thị đường trung bình</label>
                                    </div>*@
                                    <div class="btn-group" data-toggle="buttons">
                                        <label class="btn btn-primary">
                                            <input type="radio" name="radiocharttype" data-chartindex="0" value="column">
                                            <img src="~/Content/Images/bieudo-03.png" />
                                        </label>
                                        <label class="btn btn-primary">
                                            <input type="radio" name="radiocharttype" data-chartindex="0" value="line">
                                            <img src="~/Content/Images/bieudo-01.png" />
                                        </label>
                                        <label class="btn btn-primary active">
                                            <input type="radio" name="radiocharttype" data-chartindex="0" value="spline" checked>
                                            <img src="~/Content/Images/bieudo-02.png" />
                                        </label>
                                    </div>
                                    @*@if(Model.TypeId == 3 || Model.TypeId == 4)
                                        {
                                            <div class="row">
                                                <label class="btn btn-primary active">
                                                    <input type="radio" name="radiochart" value="0" checked>
                                                    <img src="~/Content/Images/bieudo-03.png" />
                                                </label>

                                                <label class="btn btn-primary">
                                                    <input type="radio" name="radiochart" value="1">
                                                    <img src="~/Content/Images/bieudo-01.png" />
                                                </label>
                                                <label class="btn btn-primary">
                                                    <input type="radio" name="radiochart" value="2" >
                                                    <img src="~/Content/Images/bieudo-02.png" />
                                                </label>
                                                <label class="btn btn-primary">
                                                    <input type="radio" name="radiochart" value="3">
                                                    <img src="~/Content/Images/bieudo-02.png" />
                                                </label>
                                            </div>
                                        }*@

                                </div>
                                <div class="col-md-2 alert alert-block alert-success" id="fixed-tooltip" style="display:none">
                                    <h4 class="title"></h4>
                                    <p class="content"></p>
                                </div>
                            </div>

                            <div class="row">
                                <table id="table-report" class="table table-striped table-bordered" cellspacing="0" width="100%">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Tuần</th>
                                            <th colspan="3">Lượt xem không trùng</th>
                                            <th colspan="2">So với trung bình</th>
                                            <th colspan="3">Lượt xem trùng</th>
                                            <th colspan="2">So với trung bình</th>
                                            <th colspan="2">Tỷ lệ xem lại</th>
                                            <th colspan="4">Video</th>

                                        </tr>
                                        <tr>
                                            @*<th></th>*@
                                            @*Lượt xem không trùng*@
                                            <th><span data-toggle="tooltip" title="Tổng lượt xem không trùng">Lượt xem</span></th>
                                            <th><span data-toggle="tooltip" title="Chênh lệch so với tuần trước">Thay đổi</span></th>
                                            <th><span data-toggle="tooltip" title="Phần trăm chênh lệch so với tuần trước">% thay đổi</span></th>
                                            @*So với trung bình  *@
                                            <th><span data-toggle="tooltip" title="Chênh lệch so với tuần trước">Thay đổi</span></th>
                                            <th><span data-toggle="tooltip" title="% chênh lệch so với tuần trước">% thay đổi</span></th>
                                            @*Lượt xem trùng  *@
                                            <th><span data-toggle="tooltip" title="Tổng lượt xem bao gồm cả lượt xem trùng">Lượt xem</span></th>
                                            <th><span data-toggle="tooltip" title="Chênh lệch tổng lượt xem so với tháng trước">Thay đổi</span></th>
                                            <th><span data-toggle="tooltip" title="Phần trăm chênh lệch tổng lượt xem so với tuần trước">% Thay đổi</span></th>
                                            @*So với trung bình  *@
                                            @*<th>% trung binh</th>*@
                                            <th>Thay đổi</th>
                                            <th>% thay đổi</th>
                                            @*Tỷ lệ xem lại *@
                                            <th>Lượt xem</th>
                                            <th>%</th>
                                            <th>Số lượng</th>
                                            <th>Thời lượng</th>
                                            <th>Lượt xem/video</th>
                                            <th>Lượt xem/giờ</th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <tr>
                                            <th style="text-align:left">Trung bình</th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                    <tbody></tbody>
                                </table>
                            </div>

                        </div>
                        <div class="tab-pane fade" id="tab-3">
                            @Html.Action("CompareVideoReport", "VideoAccess", new { catId = Model.Id })

                        </div>
                        <div class="tab-pane fade" id="tab-4">
                            <div class="col-md-10">
                                <div id="chart-2" style="height: 600px;" class="chart"></div>
                            </div>
                            @Html.Action("CompareVideoReportNewReview", "VideoAccess")
                        </div>
                        <div class="tab-pane fade" id="tab-5">
                            <div class="col-md-10">
                                <div id="chart-3" style="height: 600px; min-width: 310px;" class="chart"></div>
                            </div>
                            @Html.Action("CompareVideoReportNewOther", "VideoAccess", new { catId = Model.Id, year = DateTime.Now.Year })
                        </div>

                        @if (!User.IsInRole("kinhdoanh"))
                        {
                        <div class="tab-pane fade" id="tab-6">
                            <div class="row">
                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">
                                        <span class="headlineview">Độ tuổi</span>

                                        <ul>
                                            <li>Name - SessionCount - NewUser</li>
                                            @foreach (var age in ages)
                                                {
                                                <li>@age.Name - @age.SessionCount - @age.NewUser</li>
                                                }
                                        </ul>

                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">
                                        <span class="headlineview">Giới tính</span>

                                        <ul>
                                            <li>Name - SessionCount - NewUser</li>
                                            @foreach (var gender in genders)
                                                {
                                                <li>@gender.Name - @gender.SessionCount - @gender.NewUser</li>
                                                }
                                        </ul>

                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">
                                        <span class="headlineview">Mạng xã hội</span>

                                        <ul>
                                            <li>Name - SessionCount - PageView</li>
                                            @foreach (var socialNetwork in socialNetworks)
                                                {
                                                <li>@socialNetwork.Name - @socialNetwork.SessionCount - @socialNetwork.PageView</li>
                                                }
                                        </ul>

                                    </div>
                                </div>

                                <div class="col-sm-3">
                                    <div class="main-box infographic-box">
                                        <span class="headlineview">Thành phố</span>

                                        <ul>
                                            <li>Name - SessionCount - NewUser</li>
                                            @foreach (var city in cities)
                                                {
                                                <li>@city.Name - @city.SessionCount - @city.NewUser</li>
                                                }
                                        </ul>

                                    </div>
                                </div>

                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section styles {
    <link href="~/Content/DataTable/dataTables.bootstrap.css" rel="stylesheet" />
    <link href="~/Content/DataTable/buttons.dataTables.css" rel="stylesheet" />
    <style>
        td.week {
            width: 10%;
        }

        .tooltip {
            font-size: 14px;
        }

        .popover {
            color: black;
        }

        .popover-content {
            width: 800px;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/1/daterangepicker-bs3.css" />

}

@section scripts {
    <script src="~/Scripts/DataTable/jquery.dataTables.js"></script>
    <script src="~/Scripts/DataTable/dataTables.bootstrap.js"></script>
    <script src="~/Scripts/DataTable/dataTables.buttons.js"></script>
    <script src="~/Scripts/DataTable/jszip.min.js"></script>
    <script src="~/Scripts/DataTable/buttons.html5.js"></script>
    <script src="~/Scripts/DataTable/buttons.print.js"></script>
    <script src="~/Scripts/DataTable/buttons.colVis.js"></script>

    <script type="text/javascript" src="~/Scripts/jspdf/libs/base64.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/2.9.0/moment.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/1/daterangepicker.js"></script>

    @*Highchart*@
    <script src="~/Content/HighStock/js/highstock.js"></script>
    <script src="~/Content/HighStock/js/modules/exporting.js"></script>
    <script src="~/Scripts/app/Allreports/index.js"></script>
    <script>
        //Ẩn tab so sánh theo tuần nếu chuyên mục ko thuộc 
        var catTypeId = "@Model.TypeId";
        if (catTypeId < 3)
        {
            $("ul.nav-tabs li:nth-child(3)").hide();
            $("ul.nav-tabs li:nth-child(4)").hide();
            $("ul.nav-tabs li:nth-child(5)").hide();
        }

        var today = moment(new Date());
        var catid = '@Model.Id';
        function makeTable($table, url, complete) {
            var newTable = $table.DataTable({
                destroy: true,
                "ajax":
                {
                    "url": url,
                    "dataSrc": ""
                },
                'columnDefs': [
                    {
                        'targets': 0,
                        'class': 'week',
                        'render': function (data, type, full, meta) {
                            var res = full.Name.split(" - ");
                            var href = '/VideoAccess/VideoReportByCat?catId=@Model.Id&from=' + res[0] + '&to=' + res[1];
                            return '<a href="' + href + '">Tuần ' + data + '</a>';
                        },
                        createdCell: function (td, cellData, rowData, row, col) {

                            $(td).find('a').attr('data-toggle', 'tooltip').attr('title', rowData.Name).attr('data-placement', 'right');
                        }
                    },
                        {
                            targets: 1,
                            render: function (data, type, full, meta) {
                                return '<div>' + data + '<i class="fa fa-exclamation-circle pull-right"></i></div>';
                            },
                            createdCell: function (td, cellData, full, row, col) {
                                var res = full.Name.split(" - ");
                                $(td).find('div').attr('data-toggle', 'popover').attr('data-placement', 'right').attr('data-html', 'true').attr('title', "Tuần " + full.Week + " (" + full.Name + ")")
                                    //.attr('data-from', res[0]).attr('data-to', res[1])
                                    .attr('data-url', '/VideoAccess/PartialCatWeekDateReport?catId=@(Model.Id)&from=' + res[0] + '&to=' + res[1])
                                ;
                            }
                        },
                        {
                            'targets': 2,
                            render: function (data, type, full, meta) {
                                return '<div><span>' + data + '</span><i class="fa fa-exclamation-circle pull-right"></i></div>';
                            },
                            createdCell: function (td, cellData, full, row, col) {
                                var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                $(td).addClass(className);
                                var res = full.Name.split(" - ");
                                $(td).find('div').attr('data-toggle', 'popover').attr('data-placement', 'right').attr('data-html', 'true').attr('title', "Tuần " + full.Week + " (" + full.Name + ")")
                                    .attr('data-url', '/VideoAccess/PartialCatWeekChangeReport?catId=@(Model.Id)&from=' + res[0] + '&to=' + res[1]);
                            }
                        },
                        {
                            'targets': 3,

                            createdCell: function (td, cellData, full, row, col) {
                                var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                $(td).addClass(className);
                            }
                        },
                        {
                            'targets': 4,
                            render: function (data, type, full, meta) {
                                return '<div><span>' + data + '</span><i class="fa fa-exclamation-circle pull-right"></i></div>';
                            },
                            createdCell: function (td, cellData, full, row, col) {
                                var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                $(td).addClass(className);

                                var res = full.Name.split(" - ");
                                $(td).find('div').attr('data-toggle', 'popover').attr('data-placement', 'right').attr('data-html', 'true').attr('title', "Tuần " + full.Week + " (" + full.Name + ")")
                                   .attr('data-url', '/VideoAccess/PartialCatWeekAvgChangeReport?catId=@(Model.Id)&from=' + res[0] + '&to=' + res[1] + '&avgWeek=' + full.AvgIPViewCount);
                            }
                        },
                            {
                                'targets': 5,
                                createdCell: function (td, cellData, rowData, row, col) {
                                    var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                    $(td).addClass(className);
                                }
                            },
                            {
                                'targets': 7,
                                createdCell: function (td, cellData, rowData, row, col) {
                                    var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                    $(td).addClass(className);
                                }
                            },
                            {
                                'targets': 8,
                                createdCell: function (td, cellData, rowData, row, col) {
                                    var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                    $(td).addClass(className);
                                }
                            },
                            {
                                'targets': 9,
                                createdCell: function (td, cellData, rowData, row, col) {
                                    var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                    $(td).addClass(className);
                                }
                            },
                            {
                                'targets': 10,
                                createdCell: function (td, cellData, rowData, row, col) {
                                    var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                    $(td).addClass(className);
                                }
                            },
                            {
                                'targets': 15,
                                render: function (data, type, full, meta) {
                                    return parseFloat(Math.round((full.IPViewCount / full.VideoCount) * 100) / 100).toFixed(2);
                                }
                            },
                            {
                                'targets': 16,
                                render: function (data, type, full, meta) {
                                    return parseFloat(Math.round((full.IPViewCount / full.VideoTime) * 100) / 100).toFixed(2);
                                }
                            }

                ],
                "rowCallback": function (row, data, index) {
                    //console.log(row, data, index);
                    // Bold the grade for all 'A' grade browsers
                    if (data.ViewDetail == true) {

                        $('td:eq(1)', row).addClass('details-control');
                    }

                },
                "footerCallback": function (row, data, start, end, display) {
                    var api = this.api(), data;

                    // Remove the formatting to get integer data for summation
                    var intVal = function (i) {
                        return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '') * 1 :
                            typeof i === 'number' ?
                            i : 0;
                    };

                    // avg IpViewCount
                    var data = api.column(1).data();
                    var totalIpViewCount = data.length ?
                        data.reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }) : 0;
                    var avgIpViewCount = totalIpViewCount / data.length;

                    // avg. PageViewCount
                    data1 = api.column(6).data();
                    totalPageViewCount = data1.length ?
                        data1.reduce(function (a, b) {
                            return intVal(a) + intVal(b);
                        }) : 0;
                    var avgPageViewCount = totalPageViewCount / data1.length;

                    // Update footer
                    $(api.column(1).footer()).html(
                        'Trung bình: ' + avgIpViewCount.toFixed(2) + '<br/>Tổng cộng: ' + totalIpViewCount
                        );
                    if (!isNaN(avgIpViewCount))
                        $(api.column(4).header()).append(" - " + avgIpViewCount.toFixed(2));

                    $(api.column(6).footer()).html(
                        'Trung bình: ' + avgPageViewCount.toFixed(2) + '<br/>Tổng cộng: ' + totalPageViewCount
                    );

                },
                'order': [0, 'asc'],
                "columns": [
                { "data": "Week" },
                { "data": "IPViewCount" },
                { "data": "ChangeIPViewCount" },
                { "data": "PercentIPViewCount" },
                { "data": "ChangeAvgIPViewCount" },
                { "data": "PerChangeAvgIPViewCount" },
                { "data": "PageViewCount" },
                { "data": "ChangePageViewCount" },
                { "data": "PercentPageViewCount" },
                //{ "data": "PerAvgPageViewCount" },
                { "data": "ChangeAvgPageViewCount" },
                { "data": "PerChangeAvgPageViewCount" },
                { "data": "ReviewCount" },
                { "data": "PercentReviewCount" },
                { "data": "VideoCount" },
                { "data": "VideoTime" },
                { "data": null },
                { "data": null },

                ],
                dom: 'Bfrtip',
                buttons: [
                    'excelHtml5',
                    'print',
                    "colvis"
                ],
                "searching": false,
                "paging": false,
                "info": true,
                "initComplete": function (settings, json) {
                    if (complete != null) complete();
                }
            });

            return newTable;
        }

        //CHART
        var timeRange = 'week';

        Highcharts.setOptions({
            lang: {
                loading: 'Đang tải...',
                months: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6', 'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'],
                weekdays: ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ nhật'],
                shortMonths: ['01', '02', '03', '4', '05', '06', '07', '08', '09', '10', '11', '12'],
                exportButtonTitle: "Xuất ra",
                printButtonTitle: "Khoảng",
                rangeSelectorFrom: "Từ",
                rangeSelectorTo: "Đến",
                rangeSelectorZoom: "Phóng lớn",
                printChart: "LƯU BIỂU ĐỒ",
                downloadPNG: 'Lưu ảnh PNG',
                downloadJPEG: 'Lưu ảnh JPEG',
                downloadPDF: 'Lưu tệp PDF',
                downloadSVG: 'Lưu ảnh SVG'
            }
        });
        var listChartOptions = [];
        listChartOptions.push({
            chart: { type: 'spline', animation: false },
            title: { text: 'Biểu đồ thống kê lượng truy cập' },
            legend: { enabled: true },
            tooltip:
            {
                valueDecimals: 2,
                formatter: function () {
                    var s = '';
                    //console.log(this);
                    if (timeRange == 'week')
                        s += '<b><span style="font-weight:bold; color:' + this.series.color + '">Tuần: ' + this.point.x + '</span></b>';

                    s += '<br/> <span style="font-weight:bold; color:' + this.series.color + '">Lượt xem ' + this.series.name + ': ' + this.point.y + '</span>';

                    return s;
                }

            },
            xAxis:
            {
                title: {
                    text: 'Tuần'
                },
                tickInterval: 1, // one hour
            },
            yAxis: {
                title: {
                    text: 'Lượt xem'
                }

            },
            plotOptions: {
                spline: {
                    animation: false,
                    lineWidth: 2,
                    states: {
                        hover: {
                            lineWidth: 3
                        }
                    },
                    marker: {
                        enabled: false
                    },

                    pointInterval: 1, // one hour
                },
                line:
                    {
                        animation: false

                    },
                column:
                    {
                        animation: false
                    },
                series:
                {
                    point:
                    {
                        events:
                        {
                            click: function (e) {
                                var date = getDateOfWeek(this.x, $("#yearSelect").val());

                                var selectedDate = Highcharts.dateFormat('%d/%m/%Y', date);
                                var catid = this.series.options.id;

                                var $fixedTooltip = $("#fixed-tooltip");
                                //var link = '/VideoAccess/VideoReportByCat?catid=' + catid + '&from=' + selectedDate + '&dateType=' + timeRange;

                                $fixedTooltip.show();
                                $fixedTooltip.find(".title").html(this.series.name + " - " + selectedDate);
                                $fixedTooltip.find(".content").load('/VideoAccess/GetTopVideo?catid=' + catid + '&from=' + selectedDate + '&dateType=' + timeRange);

                                //$fixedTooltip.find(".buttons").html('<a href="' + link + '" class="btn btn-default chi tiết">Xem</a>');
                            }
                        }
                    }
                }
            },
        });
        var newChartOptions = {
            chart: { type: 'column', animation: false },
            title: { text: 'Biểu đồ thống kê lượng truy cập' },
            legend: { enabled: true },
            plotOptions: {
                column: {
                    stacking: 'normal'
                }
            },
            xAxis:
           {
               title: {
                   text: 'Tuần'
               },
               tickInterval: 1, // one week
               crosshair: true
           },
            yAxis: {
                title: {
                    text: 'Lượt xem'
                }
            },
            tooltip: {
                shared: true,
                formatter: function () {
                    //console.log(this);
                    var s = '';
                    $.each(this.points, function () {
                        s = '<span style="font-weight: bold; color:' + this.series.color + '">' + this.series.name + '</span>: ' + this.y + '<br/>' + s;
                    });
                    s = '<span>' + this.points[0].key + '</span><br/>' + s;
                    return s;
                }
            }
        };
        listChartOptions.push(newChartOptions);
        listChartOptions.push(newChartOptions);
        listChartOptions.push(newChartOptions);

        var listChartId = ["main-chart", "chart-1", "chart-2", "chart-3"];
        var listChartAvg = [0, 0, 0, 0];
        var year = $("#yearSelect").val();

        function getDateOfWeek(weekNumber, year) {
            //Create a date object starting january first of chosen year, plus the number of days in a week multiplied by the week number to get the right date.
            return new Date(year, 0, ((weekNumber - 1) * 7) - 2);
        }
       
        function GetInfoBase() {
            var chartQuery = '/VideoAccess/GetInfoBase?catid=' + catid + '&year=' + year;
            $.getJSON(chartQuery, function (accessdata) {

                $('#category').empty().html("<a href='#'>" + accessdata.CategoryName + "</a>");
                $('#type').empty().html(accessdata.CategoryTypeName);
                $('#videocount').empty().html(accessdata.VideoCount);



                ////2.Thong ke luot xem
                //Tong cong tat ca
                $('#sumview').empty().html(accessdata.AllTimeView + " (100%)");
                //Tong cong trong tuan dau tien
                $('#sum7dayview').empty().html(accessdata.FirstWeekView + " (" + ((accessdata.FirstWeekView / accessdata.AllTimeView) * 100).toFixed(2) + "%)");
                //so luot xem lai
                $('#sumreview').empty().html(accessdata.Review + " (" + (accessdata.Review / accessdata.AllTimeView * 100).toFixed(2) + "%)");

                ////3.Đánh giá mức tập trung dữ liệu
                //Trung bình trong tuần đầu tiên
                $('#avg7dayview').empty().html(((accessdata.FirstWeekAverage).toFixed(2)));
                $('#firstweekaveragehighest').empty().html(accessdata.FirstWeekAverageHighest);
                //Trung bình tất cả
                $('#avgview').empty().html((accessdata.AllTimeAverage).toFixed(2));
                $('#alltimeaveragehighest').empty().html(accessdata.AllTimeAverageHighest);
                //Trung vị trong tuần đầu tiên
                $('#median7dayview').empty().html(accessdata.FirstWeekMedian);
                //Trung vị tất cả
                $('#medianview').empty().html(accessdata.AllTimeMedian);

                ////4.Đánh giá độ biến thiên dữ liệu
                //Cao nhất
                $('#maxview').empty().html(accessdata.AllTimeHighest > 0 ? accessdata.AllTimeHighest + " (<a href='/VideoAccess/VideoReport?videoId=" + accessdata.AllTimeHighestVideoId + "'>Xem thống kê video</a>)" : 0);
                //Thấp nhất
                $('#minview').empty().html(accessdata.AllTimeLowest > 0 ? accessdata.AllTimeLowest + " (<a href='/VideoAccess/VideoReport?videoId=" + accessdata.AllTimeLowestVideoId + "'>Xem thống kê video</a>)" : 0);
                //Số ngày đạt đến điểm cao nhất
                //Cao nhất 7 ngay dau
                $('#max7dayview').empty().html(accessdata.FirstWeekHighest > 0 ? accessdata.FirstWeekHighest + " (<a href='/VideoAccess/VideoReport?videoId=" + accessdata.FirstWeekHighestVideoId + "'>Xem thống kê video</a>)" : 0);
                //Thấp nhất 7 ngay dau
                $('#min7dayview').empty().html(accessdata.FirstWeekLowest > 0 ? accessdata.FirstWeekLowest + " (<a href='/VideoAccess/VideoReport?videoId=" + accessdata.FirstWeekLowestVideoId + "'>Xem thống kê video</a>)" : 0);

            });
        }

        function drawCharts(i, complete) {
            var listChartQuery = ['/VideoAccess/GetAllCatAccessDetailByWeekForChart?catid=' + catid + '&year=' + year,
              '/VideoAccess/GetAllCatAccessDetailType1ForChart?catid=' + catid + '&year=' + year,
              '/VideoAccess/GetAllCatAccessDetailType2ForChart?catid=' + catid + '&year=' + year,
              '/VideoAccess/GetAllCatAccessDetailType3ForChart?catid=' + catid + '&year=' + year,
            ];

            if (i < 4) {
                var chartQuery = listChartQuery[i];

                $.getJSON(chartQuery, function (accessdata) {
                    drawChartAndTable(i, accessdata);
                    drawCharts(i + 1, complete);
                });
            }
            if (i == 3 && complete != null)
                complete();
        }


        function drawChartAndTable(i, accessdata) {
            var chartid = listChartId[i];

            listChartAvg[i] = accessdata.avg;
            listChartOptions[i].series = accessdata.chartdata;

            if (accessdata.avg > 0) {
                listChartOptions[i].yAxis.plotLines = [{
                    id: 'plotline-avg-' + i,
                    value: accessdata.avg,
                    color: 'red',
                    width: 1,
                    label: {
                        text: 'Trung bình các tuần trong chuyên mục: ' + accessdata.avg,
                        align: 'center',
                        style: {
                            color: 'gray'
                        }
                    }
                }
                ],
                $("#" + chartid).highcharts(listChartOptions[i]);

            }
            else {
                $("#" + chartid).highcharts(listChartOptions[i]);
            }
            //So sánh tuần đầu, coi lại
            if (i == 1)
            {
                //console.log(accessdata.tabledata);
                if (accessdata.success == true) {
                    $('#table-comparevideoreport').DataTable(
                    {
                        destroy: true,
                        data: accessdata.tabledata.Videos,
                        paging: false,
                        bFilter: false,
                        order: [[1, "asc"]],
                        columns: [
                            { "data": "Month" },
                            { "data": "Week" },
                            { "data": "Title" },
                            { "data": "FirstWeek.PageView" },
                            { "data": "FirstWeek.AverageChange" },
                            { "data": "FirstWeek.Highest" },
                            { "data": "FirstWeek.Lowest" },
                            { "data": "AllTime.PageView" },
                            { "data": "AllTime.AverageChange" },
                            { "data": "AllTime.Highest" },
                            { "data": "AllTime.ViewDateCount" },
                            { "data": "ReviewReport.PageView" },
                            { "data": "ReviewReport.ViewDateCount" },
                            { "data": "VideoPeriod" },
                            { "data": "VideoDuration" },
                        ],
                        columnDefs:
                        [
                            {
                                "targets": 2,
                                "render": function (data, type, full, meta) {
                                    var href = '/VideoAccess/VideoReport?videoId=' + full.VideoId;
                                    return '<a href="' + href + '">' + data + '</a>';
                                },
                            },
                            {
                                "targets": [4, 8],
                                "createdCell": function (td, cellData, full, row, col) {
                                    var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                    $(td).addClass(className);
                                },
                                "render": function (data, type, full, meta) {
                                    return data.toFixed(2);
                                }
                            }
                        ],
                        footerCallback: function (row, data, start, end, display) {
                            var api = this.api();
                            // Update footer
                            $("#table-comparevideoreport tfoot tr:nth-child(1) th:nth-child(4)").html(accessdata.tabledata.FirstWeekView);
                            $("#table-comparevideoreport tfoot tr:nth-child(1) th:nth-child(8)").html(accessdata.tabledata.AllTimeView);

                            $("#table-comparevideoreport tfoot tr:nth-child(2) th:nth-child(4)").html(accessdata.tabledata.FirstWeekAverage);
                            $("#table-comparevideoreport tfoot tr:nth-child(2) th:nth-child(8)").html(accessdata.tabledata.AllTimeAverage);

                        }
                    });
                }
                else
                {
                    //$("ul.nav-tabs li:nth-child(3)").hide();
                }
            }
            else if(i==2) //So sánh các tuần (Trùng, không trùng)
            {
                if (accessdata.success == true) {
                    $('#table-comparevideoreportnewreview').DataTable(
                   {
                       destroy: true,
                       data: accessdata.tabledata.Videos,
                       paging: false,
                       bFilter: false,
                       order: [[1, "asc"]],
                       columns: [
                           { "data": "Month" },
                           { "data": "Week" },
                           { "data": "Title" },
                           { "data": "IPViewCount" },
                           { "data": "IPViewChange" },
                           { "data": "PercentIPViewChange" },
                           { "data": "PageViewCount" },
                           { "data": "PageViewChange" },
                           { "data": "PercentPageViewChange" },
                           { "data": "ReviewCount" },
                           { "data": "PercentPageReviewCount" },
                       ],
                       columnDefs:
                       [
                           {
                               "targets": 2,
                               "render": function (data, type, full, meta) {
                                   var href = '/VideoAccess/VideoReport?videoId=' + full.Id;
                                   return '<a href="' + href + '">' + data + '</a>';
                               },
                           },
                           {
                               "targets": [4, 5, 7, 8],
                               "createdCell": function (td, cellData, full, row, col) {
                                   var className = cellData > 0 ? "increase" : (cellData == 0 ? "" : "decrease");
                                   $(td).addClass(className);
                               },
                               "render": function (data, type, full, meta) {
                                   return data.toFixed(2);
                               }
                           }
                       ],
                       footerCallback: function (row, data, start, end, display) {
                           var api = this.api(), data;
                           $("#table-comparevideoreportnewreview tfoot tr:nth-child(2) th:nth-child(4)").html(accessdata.tabledata.AvgIPViewCount);
                           $("#table-comparevideoreportnewreview tfoot tr:nth-child(2) th:nth-child(7)").html(accessdata.tabledata.AvgPageViewCount);

                           $("#table-comparevideoreportnewreview tfoot tr:nth-child(1) th:nth-child(4)").html(accessdata.tabledata.TotalIPViewCount);
                           $("#table-comparevideoreportnewreview tfoot tr:nth-child(1) th:nth-child(7)").html(accessdata.tabledata.TotalPageViewCount);
                       }
                   });
                }
                else {
                    //$("ul.nav-tabs li:nth-child(4)").hide();
                }
            }
            //So sánh video mới, video khác
            else if (i == 3) {
                if (accessdata.success == true) {

                    var tabledata = [];
                    //console.log(accessdata.data);
                    var tbody = $("#table-comparevideoreportnewother tbody");
                    for (var j = 0; j < accessdata.chartdata[1].data.length; j++) {
                        var info = accessdata.chartdata[1].data[j];
                        tabledata[j] = [info.id, info.month, info.x, info.name, info.y, null];
                    }
                    for (var j = 0; j < accessdata.chartdata[0].data.length; j++) {
                        tabledata[j][5] = accessdata.chartdata[0].data[j].y;
                    }
                    //console.log(tabledata);
                    $("#table-comparevideoreportnewother").DataTable(
                    {
                        destroy: true,
                        data: tabledata,
                        paging: false,
                        bFilter: false,
                        order: [[1, "asc"]],
                        columnDefs: [
                        { "visible": false, "targets": 0 },
                        {
                            'targets': 3,
                            'render': function (data, type, full, meta) {
                                var href = '/VideoAccess/VideoReport?videoId=' + full[0];
                                return '<a href="' + href + '">' + data + '</a>';
                            },
                        }]
                    });
                }
                else {
                    //$("ul.nav-tabs li:nth-child(5)").hide();
                }
            }

        }

        function registerChartControl() {
            //radio checkbox - chart type
            $('input:radio[name="radiocharttype"]').change(function () {
                var charttype = $(this).val();
                var chartIndex = $(this).data("chartindex");
                listChartOptions[chartIndex].chart.type = charttype;
                $('#' + listChartId[chartIndex]).highcharts(listChartOptions[chartIndex]);
            });

            $("#cbToggleMarker").on("change", function () {
                togglePlotLine(0);
            })
        }

        function togglePlotLine(i) {
            var hasPlotLine = document.getElementById('cbToggleMarker').checked;
            if (!hasPlotLine) {
                var chart = $('#' + listChartId[i]).highcharts();
                chart.yAxis[0].removePlotLine('plotline-avg-' + i);
            }
            else {
                listChartOptions[i].yAxis.plotLines = [{
                    id: 'plotline-avg-' + i,
                    value: listChartAvg[i],
                    color: 'red',
                    width: 1,
                    label: {
                        text: 'Trung bình: ' + listChartAvg[i],
                        align: 'center',
                        style: {
                            color: 'gray'
                        }
                    }
                }]
                $("#" + listChartId[i]).highcharts(listChartOptions[i]);
            }
        }

        function render() {
            year = $("#yearSelect").val();
            //var table = $("#table-report").DataTable();
            //table.destroy();
            makeTable($("#table-report"), "/VideoAccess/GetAllCatAccessDataByNumWeek?catid=" + catid + "&year=" + year, function () {
                $('[data-toggle="tooltip"]').tooltip();
                $('[data-toggle="popover"]').mouseenter(function () {
                    var e = $(this);
                    $(this).data('mouse', 'enter');
                    e.off('hover');
                    var url = $(this).data("url");

                    $.get(url, function (d) {
                        if ($(e).data('mouse') == 'enter')
                            e.popover({ content: d }).popover('show').on('shown.bs.popover', function () {

                            });

                    });
                })
                .mouseleave(function () {
                    $(this).data('mouse', 'leave');
                    $(this).popover('hide');

                });

                @*$('[data-toggle="popover"]').popover({

                })
                .on('shown.bs.popover', function () {
                    var from = $(this).data("from");
                    var to = $(this).data("to");
                    $(this).siblings("div.popover").find(".popover-content").load("/VideoAccess/PartialCatWeekDateReport?catId=@Model.Id&from=" + from + "&to=" + to);
                });*@
            });
            drawCharts(0, registerChartControl);
            GetInfoBase();
        }
        $(function () {

            $(".chart").each(function (i, element) {
                $(element).css("width", $(".tab-content-body").width() * 0.8);

            })
            //$('.tab-pane').width(1557);
            render();

            $("#yearSelect").on("change", function () {
                $('#selected-year').empty().html($(this).val());
                render();
            });

            $('#sidebar-nav #devReportMng').toggleClass("active");
            $('#sidebar-nav #devReportMng').siblings().removeClass("active");

            $('#sidebar-nav a#dr-li-3').toggleClass("active");
            $('#sidebar-nav a#dr-li-3').parent().siblings().removeClass("active");


        });
    </script>
}